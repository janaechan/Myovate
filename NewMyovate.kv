#: import NoTransition kivy.uix.screenmanager.NoTransition
#:import Factory kivy.factory.Factory

<CustomizedLabel@Label>:
    font_size: '20sp'

<CustomizedButton>:
    font_size: '20sp'

<RunningScreenRow>:
    id: row
    orientation: 'vertical'
    canvas.before:
        Color:
            #rgba: 0.5, 0.5, 0.5, 1
            rgba: (.0, 0.9, .1, .3) if self.selected else (0, 0, 0, 1)
            #rgba: (.0, 0.9, .1, .3) if self.selected else (0, 0, 1, 1)
        Rectangle:
            size: self.size
            pos: self.pos
    sensor_name: ''
    sensor_loc: ''
    but_mapping: ''
    need_calibration: ''
    BoxLayout:
        size_hint: [1, 0.2]
        orientation: 'horizontal'
        CustomizedLabel:
            text: 'Sensor Name: ' + root.sensor_name
        CustomizedLabel:
            text: 'Sensor Location: ' + root.sensor_loc
        CustomizedLabel:
            text: 'Mapped to: ' + root.but_mapping
        CustomizedLabel:
            text: 'Calibrated? ' + 'NO' if root.need_calibration else 'YES'

    BoxLayout:
        orientation: 'horizontal'
        Graph:
            id: graph
            xlabel: ""
            ylabel: "Level"
            x_ticks_minor:5
            x_tics_major:25
            y_ticks_major:50
            x_grid: True
            y_grid: True
            padding: 5
            pos: root.pos
        BoxLayout:
            orientation: 'vertical'
            size_hint: [0.5, .5]
            CustomizedButton:
                text: "START"
                bold: True
                on_press: root.start()
            CustomizedButton:
                text: "STOP"
                bold: True
                on_press: root.stop()
<Row>:
    id: row
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 0.5, 0.5, 0.5, 1
            #rgba: (.0, 0.9, .1, .3) if self.selected else (0, 0, 0, 1)
        Rectangle:
            size: self.size
            pos: self.pos
    sensor_name: ''
    sensor_loc: ''
    but_mapping: ''
    need_calibration: True
    BoxLayout:
        size_hint: [1, 0.2]
        orientation: 'horizontal'
        CustomizedLabel:
            text: 'Sensor Name: ' + root.sensor_name
            #size_hint: [1, .2]
        CustomizedLabel:
            text: 'Sensor Location: ' + root.sensor_loc
        CustomizedLabel:
            text: 'Mapped to: ' + root.but_mapping
        CustomizedLabel:
            text: 'Calibrated? ' + 'NO' if root.need_calibration else 'YES'
    BoxLayout:
        orientation: 'horizontal'
        Graph:
            id: graph
            xlabel: ""
            ylabel: "Level"
            x_ticks_minor: 5
            x_tics_major: 25
            y_ticks_major: 50
            x_grid: True
            y_grid: True
            padding: 5
            pos: root.pos
        BoxLayout:
            orientation: 'vertical'
            size_hint: [0.5, .5]
            CustomizedButton:
                text: "Remove Sensor"
                on_press:
                    Factory.ConfirmDeletePopup(root).open()
            CustomizedButton:
                text: "Edit Sensor"
                on_press:
                    Factory.AddSensorPopup(root).open()
            CustomizedButton:
                text: "START"
                bold: True
                on_press: root.start()
            CustomizedButton:
                text: "STOP"
                bold: True
                on_press: root.stop()


<SessionHistoryRow>:
    canvas.before:
        Color:
            rgba: (.0, 0.9, .1, .3) if self.selected else (0, 0, 0, 1)
        Rectangle:
            size: self.size
            pos: self.pos
    session_name: ''
    session_date: ''
    CustomizedLabel:
        text: root.session_date
    CustomizedLabel:
        text: root.session_name

<SelectableLabel>:
    # Draw a background to indicate selection
    color: 0,0,0,1
    canvas.before:
        Color:
            rgba: (.0, 0.9, .1, .3) if self.selected else (0, 0, 0, 1)
        Rectangle:
            pos: self.pos
            size: self.size

ScreenManagement:
    transition: NoTransition()
    MainScreen:
        id: main
        name: "main"
    StartSessionScreen:
        id: start_session
        name: "start_session"
    RunningSessionScreen:
        id: running_session
        name: "running_session"
    SessionHistoryScreen:
        id: session_history
        name: "session_history"
    ProgressScreen:
        id: progress
        name: "progress"
    AwardsScreen:
        id: awards
        name: "awards"
    AboutUsScreen:
        id: about_us
        name: "about_us"


<DropDownMenu>:
    Button:
        on_release: app.root.current = "main"
        on_press: app.root.drop_down.dismiss()
        text: "Home"
        size_hint_y: None
        size_y: 48
    Button:
        on_release: app.root.current = "start_session"
        on_press:
            app.root.drop_down.dismiss()
            #app.root.add_sensor_popup.open()
        text: "Start Session"
        size_hint_y: None
        size_y: 48
    Button:
        on_release: app.root.current = "session_history"
        on_press: app.root.drop_down.dismiss()
        text: "Session History"
        size_hint_y: None
        size_y: 48
    Button:
        on_release: app.root.current = "progress"
        on_press: app.root.drop_down.dismiss()
        text: "Progress Report"
        size_hint_y: None
        size_y: 48
    Button:
        on_release: app.root.current = "awards"
        on_press: app.root.drop_down.dismiss()
        text: "Awards"
        size_hint_y: None
        size_y: 48
    Button:
        on_release: app.root.current = "about_us"
        on_press: app.root.drop_down.dismiss()
        text: "About Us"
        size_hint_y: None
        size_y: 48

<CalibrationSetupPopup>:
    id: calibration_setup_pop
    size_hint: 0.5, 0.5
    title: ''
    auto_dismiss: False
    FloatLayout:
        CustomizedLabel:
            text:"Step 1: Place the red sensor on the targeted muscle"
            pos_hint: {'center_x': 0.5, 'center_y': 0.7}
        CustomizedLabel:
            text:"Step 2: Place the black sensor on a nearby bone"
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}

        CustomizedButton:
            pos: self.parent.pos
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'Cancel Calibration'
            on_press:
                calibration_setup_pop.dismiss()
        CustomizedButton:
            pos: (self.parent.pos[0] + self.parent.width/2, self.parent.pos[1])
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'Begin Calibration'
            on_press:
                calibration_setup_pop.dismiss()
                Factory.CalibrationRelaxPopup().open()


<CalibrationRelaxPopup>:
    id: calibration_relax_pop
    cp: cp
    size_hint: 0.5, 0.5
    title: ''
    auto_dismiss: False
    r_cal: relax_calibration
    on_open: root.puopen()
    FloatLayout:
        id: layout
        CustomizedLabel:
            text: "Please relax your muscle until progress bar full."
            pos_hint: {'center_x': 0.5, 'center_y': 0.7}
        CustomizedLabel:
            id: relax_calibration
            text: "Calibration in progress ..."
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}
        ProgressBar:
            id: cp
            pos_hint: {'center_x': 0.5, 'center_y': 0.4}
            max: 100
            value: 0
        CustomizedButton:
            pos_hint: {'center_x': 0.25, 'center_y': 0.15}
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'Cancel Calibration'
            on_press:
                calibration_relax_pop.dismiss()

<CalibrationContractPopup>:
    id: calibration_contract_pop
    cp: cp
    size_hint: 0.5, 0.5
    c_cal: contract_calibration
    auto_dismiss: False
    title: ''
    on_open: root.puopen()
    FloatLayout:
        id: layout
        CustomizedLabel:
            text: "Contract targeted muscle as much as possible and wait until\nthe progress bar is filled"
            halign: "center"
            pos_hint: {'center_x': 0.5, 'center_y': 0.7}
        CustomizedLabel:
            id: contract_calibration
            text: "Calibration in progress ..."
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}
        ProgressBar:
            id: cp
            pos_hint: {'center_x': 0.5, 'center_y': 0.4}
            max: 100
            value: 0
        CustomizedButton:
            pos_hint: {'center_x': 0.25, 'center_y': 0.15}
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'Cancel Calibration'
            on_press:
                calibration_contract_pop.dismiss()

<CalibrationCompletePopup>:
    id: calibration_complete_pop
    size_hint: 0.5, 0.5
    title: ''
    auto_dismiss: False
    FloatLayout:
        id: layout
        CustomizedLabel:
            text: "Calibration Complete. Session ready to begin."
            halign: "center"
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        CustomizedButton:
            pos_hint: {'center_x': 0.5, 'center_y': 0.15}
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'Done'
            on_press:
                calibration_complete_pop.dismiss()

<AddSensorPopup>:
    id: add_sensor_pop
    size_hint: 0.6, 0.6
    auto_dismiss: False
    title: ''
    FloatLayout:
        CustomizedLabel:
            id: sensor_name_id
            text: "Sensor Name"
            size_hint_y: None
            pos_hint: ({'center_x': 0.20, 'center_y': 0.80})
        TextInput:
            id: sensor_name_input
            text: root.rv_data[root.index]['sensor_name'] if root.rv_data else ''
            focus: True
            height: self.minimum_height
            size_hint: 0.3, None
            multiline: False
            pos_hint: ({'center_x': 0.55, 'center_y': 0.80})
        CustomizedLabel:
            id: sensor_loc_id
            text: "Sensor Location"
            size_hint_y: None
            pos_hint: ({'center_x': 0.20, 'center_y': 0.65})
        TextInput:
            id: sensor_loc_input
            text: root.rv_data[root.index]['sensor_loc'] if root.rv_data else ''
            focus: True
            height: self.minimum_height
            size_hint: 0.3, None
            multiline: False
            pos_hint: ({'center_x': 0.55, 'center_y': 0.65})
        CustomizedLabel:
            id: but_type_id
            text: "Button Type:"
            size_hint_y: None
            pos_hint: ({'center_x': 0.20, 'center_y': 0.50})
        ToggleButton:
            id: game_pad_toggle
            text: 'Game pad'
            group: 'button_type'
            allow_no_selection: False
            size: self.texture_size
            padding: (20, 5)
            size_hint: None, None
            pos_hint: ({'center_x': 0.70, 'center_y': 0.50})
        ToggleButton:
            id: keyboard_toggle
            text: 'Keyboard'
            group: 'button_type'
            state: 'down'
            allow_no_selection: False
            size: self.texture_size
            padding: (20, 5)
            size_hint: None, None
            pos_hint: ({'center_x': 0.45, 'center_y': 0.50})
        CustomizedLabel:
            id: but_mapping_id
            text: "Map to: "
            size_hint_y: None
            pos_hint: ({'center_x': 0.20, 'center_y': 0.35})
        TextInput:
            id: but_mapping_input
            text: root.rv_data[root.index]['but_mapping'] if root.rv_data else ''
            focus: True
            height: self.minimum_height
            size_hint: 0.3, None
            multiline: False
            input_type: 'text'
            keyboard_suggestions: True
            pos_hint: ({'center_x': 0.555, 'center_y': 0.35})
            on_text: root.on_text()
        CustomizedButton:
            id: dismiss_but
            text: 'Cancel'
            size: self.texture_size
            padding: (20, 10)
            size_hint: None, None
            pos_hint: ({'center_x': 0.30, 'center_y': 0.15})
            on_press:
                root.cancel_adding_sensor()
        CustomizedButton:
            text: 'Calibrate Sensor'
            size: self.texture_size
            padding: (20, 10)
            size_hint: None, None
            pos_hint: ({'center_x': 0.70, 'center_y': 0.15})
            on_press:
                app.root.get_screen('start_session').insert(sensor_name_input.text, sensor_loc_input.text, but_mapping_input.text) if sensor_name_input.text and sensor_loc_input.text and but_mapping_input.text else print('Cannot Calibrate Sensor')
                root.clear_text_input() if sensor_name_input.text and sensor_loc_input.text and but_mapping_input.text else Factory.MissingFieldPopup().open()

        #DropDownWidget:
        #    pos_hint: ({'center_x': 0.70, 'center_y': 0.35})
        #    size: (300, 60)
        #    size_hint: None, None

<DropDownWidget>:
    canvas:
        Color:
            rgba:(1, 1, 1, 1)
        Rectangle:
            pos: self.pos
            size: self.size

    orientation: 'vertical'
    spacing: 2
    txt_input: txt_input
    rv: rv

    MyTextInput:
        id: txt_input
        size_hint_y: None
        height: 50
    RV:
        id: rv

<MyTextInput>:
    readonly: False
    multiline: False


<RV>:
    canvas:
        Color:
            rgba: 0,0,0,.2

        Line:
            rectangle: self.x +1 , self.y, self.width - 2, self.height -2
    bar_width: 10
    scroll_type:['bars']
    viewclass: 'SelectableLabel'
    SelectableRecycleBoxLayout:
        default_size: None, dp(20)
        default_size_hint: 0.3, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'
        multiselect: False

<ConfirmDeletePopup>:
    id: confirm_delete_popup
    size_hint: 0.5, 0.5
    auto_dismiss: False
    title: ''
    separator_color: [0 / 255., 0 / 255., 0 / 255., 1.]
    FloatLayout:
        CustomizedLabel:
            text: "Confirm removing sensor:"
            halign: "center"
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        CustomizedButton:
            pos_hint: {'center_x': 0.25, 'center_y': 0.15}
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'Yes'
            on_press:
                confirm_delete_popup.dismiss()
                confirm_delete_popup.remove()
        CustomizedButton:
            pos_hint: {'center_x': 0.75, 'center_y': 0.15}
            size: self.parent.width/2, self.parent.height/5
            size_hint: None, None
            text: 'No'
            on_press:
                confirm_delete_popup.dismiss()

<MissingFieldPopup>:
    id: missing_field_popup
    size_hint: 0.5, 0.5
    auto_dismiss: False
    title: ''
    separator_color: [0 / 255., 0 / 255., 0 / 255., 1.]
    FloatLayout:
        CustomizedLabel:
            text: "Please fill in all fields."
            halign: "center"
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}

        CustomizedButton:
            pos: (self.parent.pos[0], self.parent.pos[1])
            size: self.parent.width, self.parent.height/5
            size_hint: None, None
            text: 'OK'
            on_press:
                missing_field_popup.dismiss()

<AddArduinoPopup>:
    id: add_arduino_popup
    size_hint: 0.5, 0.5
    auto_dismiss: False
    title: ''
    separator_color: [0 / 255., 0 / 255., 0 / 255., 1.]
    FloatLayout:
        CustomizedLabel:
            text: 'Find your Arduino to connect to.'
            halign: "center"
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}

        CustomizedButton:
            pos: (self.parent.pos[0], self.parent.pos[1])
            size: self.parent.width, self.parent.height/5
            size_hint: None, None
            text: 'Find Arduino'
            #on_press:

<MainScreen>:
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})
        CustomizedLabel:
            text: "[b] INNOVATE [/b]"
            font_size: min(root.height, root.width) / 20
            pos_hint: ({'center_x': 0.35, 'center_y': 0.8})
            markup: True
        CustomizedLabel:
            text: "[b] MOTIVATE [/b]"
            font_size: min(root.height, root.width) / 20
            pos_hint: ({'center_x': 0.40, 'center_y': 0.7})
            markup: True
        CustomizedLabel:
            text: "[b] ACTIVATE [/b]"
            font_size: min(root.height, root.width) / 20
            pos_hint: ({'center_x': 0.45, 'center_y': 0.6})
            markup: True
        CustomizedLabel:
            text: "[b] MYOVATE [/b]"
            font_size: min(root.height, root.width) / 10
            pos_hint: ({'center_x': 0.5, 'center_y': 0.5})
            markup: True


<StartSessionScreen>:
    rv: rv
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})

        CustomizedLabel:
            text: 'Complete all fields to start a session.'
            size_hint_y: None
            pos_hint: ({'center_x': 0.5, 'top': 0.95})
        CustomizedLabel:
            id: session_name_id
            text: "Session Name"
            pos_hint: ({'center_x': 0.15, 'center_y':0.8})
        TextInput:
            id: session_name_input
            focus: True
            #input_filter: lambda text, from_undo: text[:5 - len(self.text)]
            height: self.minimum_height
            size_hint: 0.3, None
            multiline: False
            pos_hint: ({'center_x': 0.4, 'center_y': 0.8})
        CustomizedLabel:
            id: session_date_id
            text: "Date"
            pos_hint: ({'center_x': 0.15, 'center_y':0.75})
        TextInput:
            id: session_date_input
            text: root.session_date
            focus: True
            #input_filter: lambda text, from_undo: text[:5 - len(self.text)]
            height: self.minimum_height
            size_hint: 0.3, None
            multiline: False
            pos_hint: ({'center_x': 0.4, 'center_y': 0.75})
        CustomizedButton:
            text: 'Add New Sensor'
            pos_hint: ({'center_x': 0.7, 'center_y': 0.75})
            size: self.texture_size
            padding: (60, 15)
            size_hint: None, None
            on_release: root.add_sensor_popup.open()
        RecycleView:
            id: rv
            pos_hint: ({'center_x': 0.5, 'center_y': 0.4})
            size_hint: .9, .5
            scroll_type: ['bars', 'content']
            scroll_wheel_distance: dp(114)
            bar_width: dp(10)
            viewclass: 'Row'
            SelectableRecycleBoxLayout:
                id: controller
                key_selection: 'selectable'
                default_size: None, dp(200)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: dp(25)
                touch_multiselect: True
        CustomizedButton:
            text: "Start Session"
            pos_hint: ({'center_x': 0.5, 'center_y': 0.05})
            size: self.texture_size
            padding: (80, 20)
            size_hint: None, None
            on_press:
                root.clear_text_input() if session_name_input.text and session_date_input.text and rv.data else Factory.MissingFieldPopup().open()
                #root.manager.get_screen('session_history').insert(session_name_input.text, rv.data)
                #root.manager.get_screen('running_session').insert(session_name_input.text, session_date_input.text, rv.data)
                #app.root.current = "running_session"
                #root.start_session()
                #app.root.get_screen('start_session').insert(sensor_name_input.text, sensor_loc_input.text, but_mapping_input.text) if sensor_name_input.text and sensor_loc_input.text else print('Cannot Calibrate Sensor')


<RunningSessionScreen>:
    rv: rv
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})

        CustomizedLabel:
            text: 'Current Session'
            size_hint_y: None
            pos_hint: ({'center_x': 0.5, 'top': 0.95})
        CustomizedLabel:
            id: session_name_id
            text: "Session Name"
            pos_hint: ({'center_x': 0.15, 'center_y':0.8})
        CustomizedLabel:
            id: session_name_input
            text: root.session_name
            pos_hint: ({'center_x': 0.4, 'center_y': 0.8})
        CustomizedLabel:
            id: session_date_id
            text: "Date"
            pos_hint: ({'center_x': 0.15, 'center_y':0.75})
        CustomizedLabel:
            id: session_date_input
            text: root.session_date
            pos_hint: ({'center_x': 0.4, 'center_y': 0.75})
        RecycleView:
            id: rv
            pos_hint: ({'center_x': 0.5, 'center_y': 0.4})
            size_hint: .9, .5
            scroll_type: ['bars', 'content']
            scroll_wheel_distance: dp(114)
            bar_width: dp(10)
            viewclass: 'RunningScreenRow'
            SelectableRecycleBoxLayout:
                id: controller
                key_selection: 'selectable'
                default_size: None, dp(200)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: dp(25)
                touch_multiselect: True
        CustomizedButton:
            text: "End Session"
            pos_hint: ({'center_x': 0.5, 'center_y': 0.05})
            size: self.texture_size
            padding: (80, 20)
            size_hint: None, None
            #on_press: root.manager.get_screen('progress').insert(session_name_input.text, rv.data)

<ProgressScreen>:
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})
        CustomizedLabel:
            text: 'Progress Screen'
            size_hint_y: None
            pos_hint: ({'center_x': 0.5, 'top': 0.95})

<SessionHistoryScreen>:
    rv_progress: rv_progress
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})
        CustomizedLabel:
            text: 'Past Sessions'
            size_hint_y: None
            pos_hint: ({'center_x': 0.5, 'top': 0.95})

        RecycleView:
            id: rv_progress
            pos_hint: ({'center_x': 0.5, 'center_y': 0.5})
            size_hint: .9, .5
            scroll_type: ['bars', 'content']
            scroll_wheel_distance: dp(50)
            bar_width: dp(10)
            viewclass: 'SessionHistoryRow'
            SelectableRecycleBoxLayout:
                default_size: None, dp(56)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: dp(2)

<AwardsScreen>:
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})
        CustomizedLabel:
            text: 'Achievements'
            size_hint_y: None
            pos_hint: ({'center_x': 0.5, 'top': 0.95})

<AboutUsScreen>:
    FloatLayout:
        CustomizedButton:
            id: btn
            text: 'Menu'
            on_release: app.root.drop_down.open(self)
            size_hint: None, None
            size: self.texture_size
            padding: (80, 20)
            pos_hint: ({'top': 1})
        CustomizedLabel:
            text: 'Who are we?'
            size_hint_y: None
            pos_hint: ({'center_x': 0.5, 'top': 0.95})
